<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Área Admin</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/admin.css') }}"
    />

    <!-- CODIGOS JS -->

    <!-- JS testimonials -->

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const servicosContainer = document.getElementById("servicos-container");
        let servicos = [];

        try {
          const res = await fetch("/admin/listar-servicos");
          if (!res.ok) throw new Error("Erro ao carregar serviços");
          servicos = await res.json();
        } catch (e) {
          console.error(e);
          servicosContainer.innerHTML = "<p>Erro ao carregar serviços.</p>";
          return;
        }

        function criarLinhaServico() {
          const div = document.createElement("div");
          div.className = "linha-servico";
          div.style.display = "flex";
          div.style.alignItems = "center";
          div.style.gap = "10px";
          div.style.marginBottom = "10px";

          const select = document.createElement("select");
          select.name = "servico_id";
          select.required = true;
          select.style.flex = "2";
          select.style.padding = "12px";
          select.style.fontSize = "16px";
          select.style.borderRadius = "6px";
          select.style.border = "1px solid #ccc";

          const optionDefault = document.createElement("option");
          optionDefault.value = "";
          optionDefault.textContent = "-- Selecione um serviço --";
          select.appendChild(optionDefault);

          servicos.forEach((s) => {
            const option = document.createElement("option");
            option.value = s.id;
            option.textContent = s.nome;
            select.appendChild(option);
          });

          const inputPreco = document.createElement("input");
          inputPreco.type = "number";
          inputPreco.name = "preco";
          inputPreco.min = "0";
          inputPreco.step = "0.01";
          inputPreco.placeholder = "Preço (R$)";
          inputPreco.required = true;
          inputPreco.style.flex = "1";
          inputPreco.style.padding = "12px";
          inputPreco.style.fontSize = "16px";
          inputPreco.style.borderRadius = "6px";
          inputPreco.style.border = "1px solid #ccc";

          const btnAdd = document.createElement("button");
          btnAdd.type = "button";
          btnAdd.textContent = "+";
          btnAdd.title = "Adicionar novo serviço";
          btnAdd.style.padding = "12px 16px";
          btnAdd.style.fontSize = "20px";
          btnAdd.style.backgroundColor = "#28a745";
          btnAdd.style.color = "white";
          btnAdd.style.border = "none";
          btnAdd.style.borderRadius = "6px";
          btnAdd.style.cursor = "pointer";
          btnAdd.onclick = () =>
            servicosContainer.appendChild(criarLinhaServico());

          const btnRemove = document.createElement("button");
          btnRemove.type = "button";
          btnRemove.textContent = "×";
          btnRemove.title = "Remover este serviço";
          btnRemove.style.padding = "12px 16px";
          btnRemove.style.fontSize = "20px";
          btnRemove.style.backgroundColor = "#dc3545";
          btnRemove.style.color = "white";
          btnRemove.style.border = "none";
          btnRemove.style.borderRadius = "6px";
          btnRemove.style.cursor = "pointer";
          btnRemove.onclick = () => div.remove();

          div.appendChild(select);
          div.appendChild(inputPreco);
          div.appendChild(btnAdd);
          div.appendChild(btnRemove);

          return div;
        }

        // Inicializa com uma linha vazia
        servicosContainer.appendChild(criarLinhaServico());

        // Função para carregar funcionários e montar cards (já existente)
        async function loadFuncionarios() {
          const container = document.getElementById(
            "funcionarios-admin-container"
          );
          container.innerHTML = "";

          try {
            const res = await fetch("/admin/listar-funcionarios");
            if (!res.ok) throw new Error("Erro ao carregar funcionários");
            const list = await res.json();

            [...list].reverse().forEach((f) => {
              const card = document.createElement("div");
              card.className = "testimonial";

              const servicosFuncionario = f.servicos || [];
              const servicosHtml = servicosFuncionario
                .map((s) => {
                  const nomeServico =
                    servicos.find((srv) => srv.id === s.servico_id)?.nome ||
                    `ID ${s.servico_id}`;
                  return `<li>${nomeServico}: R$ ${s.preco.toFixed(2)}</li>`;
                })
                .join("");

              card.innerHTML = `
              ${
                f.foto_url
                  ? `<img src="${f.foto_url}" class="testimonial-image"/>`
                  : `<div class="testimonial-image" style="background:#444;">Sem foto</div>`
              }
              <h4>${f.nome || "—"}</h4>
              <div class="testimonial-info">
                <ul>${servicosHtml}</ul>
              </div>
              <button class="btn-remover" data-id="${f.id}">Remover</button>
            `;

              container.appendChild(card);
            });

            // ✅ DIVIDE os serviços em 2 colunas, se necessário
            container
              .querySelectorAll(".testimonial-info")
              .forEach((infoContainer) => {
                const ul = infoContainer.querySelector("ul");
                if (!ul) return;

                const items = Array.from(ul.querySelectorAll("li"));
                if (items.length > 4) {
                  const col1 = document.createElement("ul");
                  const col2 = document.createElement("ul");

                  items.forEach((item, index) => {
                    if (index < 4) col1.appendChild(item);
                    else col2.appendChild(item);
                  });

                  infoContainer.innerHTML = "";
                  infoContainer.appendChild(col1);
                  infoContainer.appendChild(col2);
                }
              });

            // Lógica de remover
            container.querySelectorAll(".btn-remover").forEach((btn) => {
              btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                if (confirm("Confirma remover este funcionário?")) {
                  try {
                    const res = await fetch(
                      `/admin/remover-funcionario/${id}`,
                      {
                        method: "DELETE",
                      }
                    );
                    const json = await res.json();
                    if (json.success) {
                      alert("Funcionário removido!");
                      loadFuncionarios();
                    } else {
                      alert("Erro: " + json.error);
                    }
                  } catch (e) {
                    alert("Erro na requisição: " + e.message);
                  }
                }
              });
            });
          } catch (e) {
            console.error(e);
            container.innerHTML = "<p>Erro ao carregar funcionários.</p>";
          }
        }

        // Submissão do formulário
        document
          .getElementById("add-funcionario-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = e.target;

            // Montar array servicos [{servico_id, preco}]
            const servicosSelecionados = [];
            const linhas = servicosContainer.querySelectorAll(".linha-servico");

            try {
              linhas.forEach((linha) => {
                const select = linha.querySelector("select");
                const inputPreco = linha.querySelector("input[name=preco]");
                if (select.value !== "" && inputPreco.value !== "") {
                  const servico_id = parseInt(select.value);
                  const preco = parseFloat(inputPreco.value);

                  if (isNaN(preco) || preco < 0) {
                    throw new Error(
                      `Preço inválido para o serviço selecionado.`
                    );
                  }

                  servicosSelecionados.push({ servico_id, preco });
                }
              });

              if (servicosSelecionados.length === 0) {
                alert("Por favor, adicione pelo menos um serviço com preço.");
                return;
              }

              const fd = new FormData(form);

              fd.delete("servicos_col1");
              fd.delete("servicos_col2");

              fd.append("servicos", JSON.stringify(servicosSelecionados));

              const res = await fetch("/admin/add-funcionario", {
                method: "POST",
                body: fd,
              });
              const json = await res.json();

              if (json.success) {
                alert("Funcionário adicionado com sucesso!");
                form.reset();
                servicosContainer.innerHTML = "";
                servicosContainer.appendChild(criarLinhaServico());
                loadFuncionarios();
              } else {
                alert("Erro: " + json.error);
              }
            } catch (error) {
              alert("Erro: " + error.message);
            }
          });

        loadFuncionarios();
      });
    </script>

    <!-- Script para exibir o form do .testimonial -->

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const btnMostrar = document.getElementById("btn-mostrar-form");
        const form = document.getElementById("add-funcionario-form");

        btnMostrar.addEventListener("click", () => {
          form.style.display = "block"; // Mostra o formulário
          btnMostrar.style.display = "none"; // Esconde o botão de mostrar
        });
      });
    </script>

    <!-- Script para atualizar visibilidade do .testimonial -->
    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const checkbox = document.getElementById("hide-testimonials");
        if (!checkbox) {
          console.error("Checkbox #hide-testimonials não encontrado no DOM");
          return;
        }

        // 1) carregar o estado salvo
        fetch("/api/section-visibility")
          .then((res) => res.json())
          .then((data) => {
            checkbox.checked = data.testimonials === true;
          })
          .catch((err) =>
            console.error("Erro ao carregar visibilidade testimonials:", err)
          );

        // 2) enviar atualização ao mudar checkbox
        checkbox.addEventListener("change", (e) => {
          const payload = { testimonials: e.target.checked };

          fetch("/api/section-visibility", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              if (!res.ok)
                return res.text().then((text) => Promise.reject(text));
              return res.json();
            })
            .then((json) => {
              console.log("Visibilidade testimonials atualizada:", json);
            })
            .catch((err) => {
              console.error("Erro ao atualizar testimonials:", err);
            });
        });
      });
    </script>

    <!-- JS GALLERY -->

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".image-upload-input").forEach((input) => {
          input.addEventListener("change", async function (e) {
            const file = e.target.files[0];
            const imageId = this.dataset.imageId;
            const preview = this.parentElement.querySelector(".image-preview");
            const status = this.parentElement.querySelector(".upload-status");

            if (!file) return;

            const formData = new FormData();
            formData.append("image", file);
            formData.append("image_id", imageId);

            try {
              status.textContent = "Enviando...";
              const response = await fetch("/api/gallery", {
                method: "POST",
                body: formData,
              });

              const result = await response.json();

              if (!response.ok)
                throw new Error(result.error || "Falha no upload");

              preview.src = result.new_url;
              status.textContent = "✔️ Atualizado!";
              setTimeout(() => (status.textContent = ""), 2000);
            } catch (error) {
              status.textContent = `Erro: ${error.message}`;
              status.style.color = "red";
            }
          });
        });

        // Atualizar visibilidade da galeria
        document
          .querySelectorAll("input[name='gallery-visibility']")
          .forEach((radio) => {
            radio.addEventListener("change", async (e) => {
              const visibility = e.target.value;
              try {
                const response = await fetch("/api/section-visibility", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ gallery: visibility }),
                });
                if (!response.ok) {
                  const erro = await response.json();
                  console.error("Erro ao atualizar gallery:", erro);
                }
              } catch (err) {
                console.error("Falha ao chamar /api/section-visibility:", err);
              }
            });
          });

        // Carregar visibilidade ao abrir a página
        (async () => {
          try {
            const visRes = await fetch("/api/section-visibility");
            const visData = await visRes.json();
            const currentGalleryVis = visData.gallery || "full";

            const radios = document.querySelectorAll(
              "input[name='gallery-visibility']"
            );
            radios.forEach((radio) => {
              radio.checked = radio.value === currentGalleryVis;
            });
          } catch (err) {
            console.error("Erro ao carregar visibilidade:", err);
          }
        })();
      });
    </script>


    <!-- JS REDES SOCIAIS -->

    <script>
      // Salvar os links das redes sociais
      document
        .getElementById("save-links-btn")
        .addEventListener("click", async () => {
          const links = {
            instagram: document.getElementById("insta-link").value,
            facebook: document.getElementById("face-link").value,
            x: document.getElementById("x-link").value,
            youtube: document.getElementById("yt-link").value,
          };

          const res = await fetch("/api/social-links", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(links),
          });

          const data = await res.json();
          if (data.message) {
            alert("Links atualizados com sucesso!");
          } else {
            alert("Erro: " + data.error);
          }
        });

      // Carregar links e visibilidade ao abrir a página
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const resLinks = await fetch("/api/social-links");
          const dataLinks = await resLinks.json();
          if (dataLinks) {
            document.getElementById("insta-link").value =
              dataLinks.instagram || "";
            document.getElementById("face-link").value =
              dataLinks.facebook || "";
            document.getElementById("x-link").value = dataLinks.x || "";
            document.getElementById("yt-link").value = dataLinks.youtube || "";
          }

          const visRes = await fetch("/api/section-visibility");
          const visData = await visRes.json();
          document.getElementById("toggle-clients").checked =
            visData.clients === true;
        } catch (err) {
          console.error("Erro ao carregar dados:", err);
        }
      });

      // Atualizar visibilidade da seção clients ao marcar/desmarcar
      document
        .getElementById("toggle-clients")
        .addEventListener("change", async (e) => {
          const updated = { clients: e.target.checked };
          await fetch("/api/section-visibility", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated),
          });
        });
    </script>
  </head>

  <!-- html-->
  <body>
    <header class="admin-header">
      <div class="container admin-header-content">
        <h1>Administração</h1>
        {% if logged_in %}
        <a href="{{ url_for('logout') }}" class="btn-logout">Sair</a>
        {% endif %}
      </div>
    </header>

    <main class="admin-main">
      <div class="container">
        {% if not logged_in %}
        <!-- Se NÃO estiver logado -->
        <section id="login-section">
          <h2><img src="{{ url_for('static', filename='img/LOGO.svg') }}" class="login-logo" alt="logo">Login
</h2>
          <form id="login-form" action="/admin/login" method="POST">
            <div class="form-group">
              <label for="email">Email:</label>
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder="Digite seu email"
              />
            </div>
            <div class="form-group">
              <label for="senha">Senha:</label>
              <input
                type="password"
                id="senha"
                name="password"
                required
                placeholder="Digite sua senha"
              />
            </div>
            <button type="submit" class="btn">Entrar</button>
          </form>
        </section>
        {% else %}
        <!-- Se JÁ estiver logado -->
        <section id="dashboard-section">
          <div class="dashboard-content">
            <h2>Painel de Administração</h2>
          </div>
        </section>

        <!-- THEME BUTTONS -->
        <div class="theme-grid">
          <div class="column">
            <section id="theme-section" class="theme-form">
              <h3>Alterar Cor do Tema (Seção)</h3>
              <div class="form-group">
                <label for="theme-color">Fundo da Seção:</label>
                <input type="color" id="theme-color" name="theme-color" value="#ffffff" />
                <button id="save-theme-btn" class="btn">Salvar Cor</button>
              </div>
            </section>

            <section id="section-font-section" class="theme-form">
              <h3>Alterar Cor da Fonte (Section)</h3>
              <div class="form-group">
                <label for="section-font-color">Fonte da Section:</label>
                <input type="color" id="section-font-color" value="#000000" />
                <button id="save-section-font-btn" class="btn">Salvar Cor</button>
              </div>
            </section>
          </div>

          <div class="divider-small"></div>

          <div class="column">
            <section id="body-section" class="theme-form">
              <h3>Alterar Cor do Fundo (Body)</h3>
              <div class="form-group">
                <label for="body-color">Fundo do Body:</label>
                <input type="color" id="body-color" name="body-color" value="#ffffff" />
                <button id="save-body-btn" class="btn">Salvar Cor</button>
              </div>
            </section>

            <section id="body-font-section" class="theme-form">
              <h3>Alterar Cor da Fonte (Body)</h3>
              <div class="form-group">
                <label for="body-font-color">Fonte do Body:</label>
                <input type="color" id="body-font-color" value="#000000" />
                <button id="save-body-font-btn" class="btn">Salvar Cor</button>
              </div>
            </section>
          </div>

          <div class="divider-small"></div>

          <div class="column">
            <section id="background-font-section" class="theme-form">
              <h3>Alterar Cor da Fonte (Background)</h3>
              <div class="form-group">
                <label for="background-font-color">Fonte do Background:</label>
                <input type="color" id="background-font-color" value="#000000" />
                <button id="save-background-font-btn" class="btn">Salvar Cor</button>
              </div>
            </section>
            
          <!-- NOVO CONTAINER COM INPUT FILE -->

          <section id="background-file-section" class="theme-form" style="text-align: center;">
            <div class="form-group" style="display: flex; justify-content: center; align-items: center; position: relative;">
              <input type="file" id="background-file" name="background-file" />
              <div style="position: relative; display: inline-block;">
                <button id="upload-background-file-btn" class="btn">Enviar</button>
                <div id="loading-spinner2" style="display:none;"></div>
              </div>
            </div>

            <!-- BOTÃO FLECHA CENTRALIZADO -->
            <div style="margin-top: 10px;">
              <button id="toggle-current-bg" class="btn" style="font-size: 14px;">
                Ver imagem atual
              </button>
            </div>

            <!-- PREVIEW OCULTO -->
            <div id="current-bg-wrapper" style="margin-top: 20px; display: none;">
              {% if showcase_url %}
                <div id="current-bg-container" style="position: relative; margin: 0 auto; width: 100%; max-width: 600px;">
                  <img
                    src="{{ showcase_url }}"
                    alt="Imagem atual"
                    id="showcase-preview-img"
                    style="width: 95%; height: auto; border: 1px solid #ccc; border-radius: 8px; display: block; margin: 0 auto;"
                  />
                  <button
                    id="close-preview-btn"
                    style="
                      position: absolute;
                      top: 50%;
                      left: 50%;
                      transform: translate(-50%, -50%);
                      background: rgba(0, 0, 0, 0.7);
                      color: white;
                      font-size: 22px;
                      border: none;
                      padding: 8px 14px;
                      border-radius: 50%;
                      cursor: pointer;
                      z-index: 10;
                      opacity: 0;
                      transition: opacity 0.2s ease;
                      pointer-events: none;
                    "
                  >✖</button>
                </div>
              {% else %}
                <p style="color: #777;">Nenhuma imagem atual encontrada.</p>
              {% endif %}
            </div>

            <!-- SCRIPT -->
            <script>
              const uploadBtn = document.getElementById("upload-background-file-btn");
              const spinner = document.getElementById("loading-spinner2");
              const fileInput = document.getElementById("background-file");

              uploadBtn.addEventListener("click", async (e) => {
                e.preventDefault();

                if (!fileInput.files.length) {
                  alert("Selecione um arquivo antes de enviar.");
                  return;
                }

                // Mostrar spinner e desabilitar botão
                uploadBtn.disabled = true;
                uploadBtn.textContent = "";
                spinner.style.display = "inline-block";

                const formData = new FormData();
                formData.append("background-file", fileInput.files[0]);

                try {
                  const res = await fetch("/upload-showcase-image", {
                    method: "POST",
                    body: formData,
                  });
                  const data = await res.json();

                  if (data.success) {
                    alert("Upload feito com sucesso!");
                    location.reload();
                  } else {
                    alert("Erro no upload: " + (data.error || "Desconhecido"));
                  }
                } catch (error) {
                  alert("Erro na requisição: " + error.message);
                } finally {
                  // Voltar ao estado normal (se não recarregar a página)
                  uploadBtn.disabled = false;
                  uploadBtn.textContent = "Enviar";
                  spinner.style.display = "none";
                }
              });

              // Toggle de imagem atual
              const toggleBtn = document.getElementById("toggle-current-bg");
              const wrapper = document.getElementById("current-bg-wrapper");

              if (toggleBtn && wrapper) {
                toggleBtn.addEventListener("click", () => {
                  const style = window.getComputedStyle(wrapper);
                  if (style.display === "none") {
                    wrapper.style.display = "block";
                    toggleBtn.style.display = "none";
                  } else {
                    wrapper.style.display = "none";
                    toggleBtn.style.display = "inline-block";
                    toggleBtn.textContent = "Ver imagem atual";
                  }
                });
              }

              // Mostrar/ocultar botão "X" no hover da imagem
              const previewImg = document.getElementById("showcase-preview-img");
              const closeBtn = document.getElementById("close-preview-btn");

              if (previewImg && closeBtn) {
                const container = document.getElementById("current-bg-container");

                container.addEventListener("mouseenter", () => {
                  closeBtn.style.opacity = "1";
                  closeBtn.style.pointerEvents = "auto";
                });

                container.addEventListener("mouseleave", () => {
                  closeBtn.style.opacity = "0";
                  closeBtn.style.pointerEvents = "none";
                });

                closeBtn.addEventListener("click", () => {
                  wrapper.style.display = "none";
                  toggleBtn.style.display = "inline-block";
                  toggleBtn.textContent = "Ver imagem atual";
                });
              }
            </script>
          </section>

          </div>
        </section>

        <!-- SCRIPT JS THEME -->

        <script>
          // ========= Carregar cores atuais ao abrir =========
          window.addEventListener("DOMContentLoaded", async () => {
            const res = await fetch("/api/theme");
            const data = await res.json();

            if (data.section_color) {
              document.getElementById("theme-color").value = data.section_color;
            }
            if (data.body_color) {
              document.getElementById("body-color").value = data.body_color;
            }
            if (data.body_font_color) {
              document.getElementById("body-font-color").value =
                data.body_font_color;
            }
            if (data.section_font_color) {
              document.getElementById("section-font-color").value =
                data.section_font_color;
            }
            if (data.background_font_color) {
              document.getElementById("background-font-color").value =
                data.background_font_color;
            }
          });

          // ========= Salvar cor da seção =========
          document
            .getElementById("save-theme-btn")
            .addEventListener("click", async () => {
              const color = document.getElementById("theme-color").value;
              const response = await fetch("/api/theme/section", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color }),
              });
              const data = await response.json();
              if (data.message) {
                alert("Seção atualizada com sucesso!");
              } else {
                alert("Erro: " + data.error);
              }
            });

          // ========= Salvar cor do body =========
          document
            .getElementById("save-body-btn")
            .addEventListener("click", async () => {
              const color = document.getElementById("body-color").value;
              const response = await fetch("/api/theme/body", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color }),
              });
              const data = await response.json();
              if (data.message) {
                alert("Body atualizado com sucesso!");
              } else {
                alert("Erro: " + data.error);
              }
            });

          // Salvar cor da fonte do background
          document
            .getElementById("save-background-font-btn")
            .addEventListener("click", async () => {
              console.log("Clique detectado em salvar fonte background");
              const color = document.getElementById(
                "background-font-color"
              ).value;
              const response = await fetch("/api/theme/background-font", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color }),
              });

              const data = await response.json(); // linha que está quebrando
              console.log("Resposta recebida:", data);

              if (data.message) {
                alert("Fonte do background atualizada com sucesso!");
              } else {
                alert("Erro: " + data.error);
              }
            });

          // Salvar cor da fonte do body
          document
            .getElementById("save-body-font-btn")
            .addEventListener("click", async () => {
              console.log("Clique detectado em salvar fonte body");
              const color = document.getElementById("body-font-color").value;
              const response = await fetch("/api/theme/body-font", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color }),
              });

              const data = await response.json(); // linha que está quebrando
              console.log("Resposta recebida:", data);

              if (data.message) {
                alert("Fonte do body atualizada com sucesso!");
              } else {
                alert("Erro: " + data.error);
              }
            });

          // Salvar cor da fonte da seção
          document
            .getElementById("save-section-font-btn")
            .addEventListener("click", async () => {
              const color = document.getElementById("section-font-color").value;
              const response = await fetch("/api/theme/section-font", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ color }),
              });
              const data = await response.json();
              if (data.message) {
                alert("Fonte da seção atualizada com sucesso!");
              } else {
                alert("Erro: " + data.error);
              }
            });
        </script>

        <!-- VIDEO FORM -->
        <h2 class="video-upload-title">Upload de Vídeo</h2>

        <div class="video-hide-checkbox-wrapper">
          <label>
            <input type="checkbox" id="video-visibility-checkbox" name="video-visibility-checkbox" />
            Ocultar Vídeo
          </label>
        </div>

        <div class="video-upload-container">
          <form
            id="upload-video-form"
            class="video-upload-form"
            enctype="multipart/form-data"
          >
            <input
              type="file"
              id="video-file"
              name="video"
              accept="video/mp4"
              required
            />
            <button type="submit" id="btn-submit">
              <span id="btn-text">Enviar</span>
            </button>
            <span id="loading-spinner"></span>
          </form>

          {% if video_url %}
          <!-- Bloco para exibir o vídeo que já está armazenado -->
          <div class="video-preview-container">
            <h3>Vídeo Armazenado</h3>
            <video src="{{ video_url }}" controls>
              <source src="{{ video_url }}" type="video/mp4" />
              Seu navegador não suporta vídeo.
            </video>
          </div>
          {% else %}
          <p style="text-align: center; color: #888; font-size: 18px">Nenhum vídeo armazenado.</p>
          {% endif %}
        </div> <!-- FECHAMENTO DO CONTAINER -->

        <script>
          // Carrega estado inicial
          async function loadVideoVisibility() {
            try {
              const res = await fetch('/api/section-visibility');
              if (!res.ok) throw new Error('Erro ao buscar visibilidade do vídeo');
              const data = await res.json();
              const videoHidden = data.video || false;
              const checkbox = document.getElementById('video-visibility-checkbox');
              checkbox.checked = videoHidden; // Agora: checked = oculto
            } catch (err) {
              console.error(err);
            }
          }

          // Atualiza backend
          async function updateVideoVisibility(isHidden) {
            try {
              const res = await fetch('/api/section-visibility', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ video: isHidden })  // Marcar = ocultar
              });
              if (!res.ok) {
                const err = await res.json();
                console.error('Erro ao atualizar vídeo:', err);
              }
            } catch (err) {
              console.error('Falha ao chamar /api/section-visibility:', err);
            }
          }

          // Listener de mudança no checkbox
          document.addEventListener('DOMContentLoaded', () => {
            loadVideoVisibility();
            const checkbox = document.getElementById('video-visibility-checkbox');
            checkbox.addEventListener('change', (e) => {
              updateVideoVisibility(e.target.checked);
            });
          });
        </script>


        <!-- Agora o script está FORA do container -->
        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("upload-video-form");
            const btn = document.getElementById("btn-submit");
            const btnText = document.getElementById("btn-text");
            const spinner = document.getElementById("loading-spinner");

            form.addEventListener("submit", async (e) => {
              e.preventDefault();
              console.log("Submit capturado!"); // DEBUG

              btn.disabled = true;
              btnText.style.display = "none";
              spinner.style.display = "inline-block";

              const formData = new FormData(form);

              try {
                const res = await fetch("/admin/upload_video", {
                  method: "POST",
                  body: formData,
                });

                const result = await res.json();

                if (result.success) {
                  alert("Upload de vídeo foi feito com sucesso!");
                  form.reset();
                  // location.reload();
                } else {
                  alert("Erro no upload: " + (result.error || "Erro desconhecido"));
                }
              } catch (err) {
                alert("Erro na requisição: " + err.message);
              } finally {
                btn.disabled = false;
                spinner.style.display = "none";
                btnText.style.display = "inline";
              }
            });
          });
        </script>


          <!-- LOGO -->
          <div class="logo-admin-container">
            <!-- Coluna esquerda: formulário -->
            <section id="logo-upload-section">
              <h2>Upload de Logo</h2>
              <form id="logo-upload-form" enctype="multipart/form-data">
                <div class="upload-box">
                  <label class="file-label">
                    Escolher Arquivo
                    <input type="file" name="logo" accept="image/*,image/svg+xml" required />
                  </label>

                  <label for="logo-height">Altura:</label>
                  <select name="height">
                    <option value="100">100px</option>
                    <option value="140">140px</option>
                    <option value="160">160px</option>
                  </select>

                  <button type="submit" class="upload-btn">Enviar Logo</button>
                </div>
              </form>
              <p id="logo-status"></p>
            </section>

            <!-- Divisor vertical -->
            <div class="divider"></div>

            <!-- Coluna direita: logos -->
            <section id="logo-display-section">
              <h2>Logos Cadastradas</h2>
              <div id="logos-list"></div>
            </section>
          </div>

          <script>
            const status = document.getElementById("logo-status");
            const logosList = document.getElementById("logos-list");

            // Função para carregar logos do backend
            async function loadLogos() {
              logosList.innerHTML = "Carregando...";
              try {
                const res = await fetch("/api/listar-logos");
                const json = await res.json();
                if (json.success) {
                  if (!json.logos || json.logos.length === 0) {
                    logosList.innerHTML = "<p>Nenhuma logo cadastrada.</p>";
                    return;
                  }
                  logosList.innerHTML = "";
                  json.logos.forEach((logo) => {
                    const div = document.createElement("div");
                    div.className = "logo-item";

                    // Define cor de fundo com base no campo bg_contraste
                    const bgColor =
                      logo.bg_contraste === "black" ? "#000000" : "#FFFFFF";

                    div.innerHTML = `
                    <div class="logo-preview" style="background-color: ${bgColor};">
                      <img src="${logo.logo_url}" alt="${logo.nome}" />
                    </div>
                    <div class="logo-info">
                      <div class="logo-nome" title="${logo.nome}">Nome: ${
                      logo.nome
                    }</div>
                      <div class="logo-altura">Altura: ${logo.height_px}px</div>
                      <div class="logo-status">
                        Status: 
                        <span class="${
                          logo.is_active ? "logo-active" : "logo-inactive"
                        }">
                          ${logo.is_active ? "Ativa" : "Inativa"}
                        </span>
                      </div>
                      <div class="logo-actions">
                        <button ${
                          logo.is_active ? "disabled" : ""
                        } onclick="ativarLogo('${logo.id}')">Ativar</button>
                        <button onclick="deletarLogo('${logo.id}', '${
                      logo.logo_url
                    }')">Remover</button>
                      </div>
                    </div>
                  `;
                    logosList.appendChild(div);
                  });
                } else {
                  logosList.innerHTML = `<p>Erro ao carregar logos: ${json.error}</p>`;
                }
              } catch (e) {
                logosList.innerHTML = `<p>Erro de rede ou inesperado: ${e.message}</p>`;
              }
            }

            // Função para ativar uma logo
            async function ativarLogo(id) {
              try {
                status.textContent = ""; // limpa mensagens anteriores
                const res = await fetch("/api/ativar-logo", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id }),
                });
                const json = await res.json();
                if (json.success) {
                  status.textContent = "Logo ativada com sucesso!";
                  loadLogos(); // Atualiza a lista para refletir a mudança
                } else {
                  status.textContent =
                    "Erro ao ativar logo: " +
                    (json.error || "Erro desconhecido");
                }
              } catch (e) {
                status.textContent = "Erro de rede ou inesperado: " + e.message;
              }
            }

            // Função para deletar uma logo
            async function deletarLogo(id, logo_url) {
              const confirmacao = confirm(
                "Tem certeza que deseja remover esta logo?"
              );
              if (!confirmacao) return;

              try {
                status.textContent = "";
                const res = await fetch("/api/deletar-logo", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ id, logo_url }),
                });

                const json = await res.json();
                if (json.success) {
                  status.textContent = "Logo removida com sucesso!";
                  loadLogos(); // Recarrega lista
                } else {
                  status.textContent =
                    "Erro ao remover logo: " +
                    (json.error || "Erro desconhecido");
                }
              } catch (e) {
                status.textContent = "Erro de rede ou inesperado: " + e.message;
              }
            }

            // Evento do formulário de upload
            document
              .getElementById("logo-upload-form")
              .addEventListener("submit", async (e) => {
                e.preventDefault();
                status.textContent = "";

                const form = e.target;
                const formData = new FormData(form);

                try {
                  const res = await fetch("/upload-logo", {
                    method: "POST",
                    body: formData,
                  });
                  if (!res.ok) {
                    status.textContent = `Erro HTTP: ${res.status} ${res.statusText}`;
                    return;
                  }
                  const result = await res.json();
                  if (result.success) {
                    status.textContent = "Logo enviada com sucesso!";
                    form.reset();
                    loadLogos(); // Recarrega as logos após upload
                  } else {
                    status.textContent =
                      "Erro: " + (result.error || "Erro desconhecido");
                  }
                } catch (error) {
                  status.textContent =
                    "Erro de rede ou inesperado: " + error.message;
                }
              });

            // Carrega logos quando a página abrir
            window.onload = loadLogos;
          </script>


          <!-- TESTIMONIALS -->
          <div id="servicos-funcionarios-admin">
            <div
              style="
                display: flex;
                align-items: baseline;
                gap: 12px;
                flex-wrap: wrap;
              "
            >
              <h3 style="font-size: 28px; font-weight: bold; margin: 0">
                Gerenciar Funcionários
              </h3>

              <!-- Checkbox para esconder a seção testimonials -->
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  font-size: 14px;
                "
              >
                <input
                  type="checkbox"
                  id="hide-testimonials"
                  name="hide_testimonials"
                />
                Esconder Seção
              </label>
            </div>

            <!-- Botão de exibir o formulário -->
            <div style="text-align: center; margin-bottom: 20px">
              <button
                id="btn-mostrar-form"
                style="
                  padding: 12px 20px;
                  font-size: 16px;
                  border-radius: 6px;
                  background-color: #007bff;
                  color: white;
                  border: none;
                  cursor: pointer;
                "
              >
                Adicionar Funcionário
              </button>
            </div>

            <!-- Formulário oculto inicialmente -->
            <form
              id="add-funcionario-form"
              enctype="multipart/form-data"
              style="display: none"
            >
              <!-- Linha dos inputs -->
              <div
                style="
                  display: flex;
                  flex-wrap: wrap;
                  gap: 10px;
                  align-items: center;
                  margin-bottom: 20px;
                "
              >
                <input
                  type="text"
                  name="nome"
                  placeholder="Nome do funcionário"
                  required
                  style="
                    flex: 2;
                    padding: 12px;
                    font-size: 16px;
                    border-radius: 6px;
                    border: 1px solid #ccc;
                  "
                />

                <input
                  type="file"
                  name="foto"
                  accept="image/*"
                  style="
                    flex: 2;
                    padding: 8px;
                    font-size: 16px;
                    border-radius: 6px;
                    border: 1px solid #ccc;
                  "
                />
              </div>

              <!-- Serviços dinâmicos -->
              <div id="servicos-container" style="margin-bottom: 20px"></div>

              <!-- Botão de envio -->
              <div style="text-align: center; margin-bottom: 40px">
                <button
                  type="submit"
                  style="
                    padding: 12px 20px;
                    font-size: 16px;
                    border-radius: 6px;
                    background-color: #007bff;
                    color: white;
                    border: none;
                    cursor: pointer;
                  "
                >
                  Salvar Funcionário
                </button>
              </div>
            </form>
          </div>

          <!-- Container onde os cards serão inseridos -->
          <div id="funcionarios-admin-container"></div>
        </div>

        
        <!-- gallery -->
        <section id="gallery-admin-section">
          <!-- 1. Adicionamos uma classe ao cabeçalho para estilizá-lo -->
          <div class="gallery-admin-header">
            <h3>Gerenciar Galeria</h3>
        
            <div class="gallery-visibility-options">
              <label>
                <input type="radio" name="gallery-visibility" value="none" />
                Esconder Seção
              </label>
              <label>
                <input type="radio" name="gallery-visibility" value="partial" />
                Mostrar 3 imagens
              </label>
              <label>
                <input type="radio" name="gallery-visibility" value="full" />
                Mostrar todas
              </label>
            </div>
          </div>
        
          <!-- 2. Adicionamos o container da grade para agrupar os itens -->
          <div id="gallery-container">
            {% for i in range(1,7) %}
            <div class="gallery-admin-item">
              <label>Posição {{ i }}:</label>
              <input
                type="file"
                accept="image/png, image/jpeg"
                class="image-upload-input"
                data-image-id="image-{{ i }}"
              />
              <img
                src="{{ gallery_images.get('image-' ~ i, '') }}"
                class="image-preview"
              />
              <div class="upload-status"></div>
            </div>
            {% endfor %}
          </div>
        </section>
        
        
        <!-- REDES SOCIAIS -->

        <section id="social-links-section">
          <div class="headline">Gerenciar Redes Sociais</div>

          <div class="form-group">
            <label for="insta-link">Instagram</label>
            <input
              type="url"
              id="insta-link"
              placeholder="https://www.instagram.com/seuperfil"
            />
          </div>

          <div class="form-group">
            <label for="face-link">Facebook</label>
            <input
              type="url"
              id="face-link"
              placeholder="https://www.facebook.com/seupagina"
            />
          </div>

          <div class="form-group">
            <label for="x-link">Twitter / X</label>
            <input
              type="url"
              id="x-link"
              placeholder="https://twitter.com/seuperfil"
            />
          </div>

          <div class="form-group">
            <label for="yt-link">YouTube</label>
            <input
              type="url"
              id="yt-link"
              placeholder="https://www.youtube.com/seucanal"
            />
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="toggle-clients" />
              Esconder Seção
            </label>
          </div>

          <button id="save-links-btn">Salvar Links</button>
        </section>
        
        <script>
          window.addEventListener("DOMContentLoaded", async () => {
            // 1. Preencher os inputs com os dados do Supabase
            try {
              const res = await fetch("/api/social-links");
              const data = await res.json();

              if (data.instagram) document.getElementById("insta-link").value = data.instagram;
              if (data.facebook) document.getElementById("face-link").value = data.facebook;
              if (data.x)        document.getElementById("x-link").value = data.x;
              if (data.youtube)  document.getElementById("yt-link").value = data.youtube;
            } catch (err) {
              console.error("Erro ao carregar os links sociais:", err);
            }

            // 2. Preencher checkbox de visibilidade dos links (se usar Supabase)
            try {
              const res = await fetch("/api/section-visibility");
              const data = await res.json();
              document.getElementById("toggle-clients").checked = data.clients === true;
            } catch (err) {
              console.error("Erro ao carregar visibilidade da seção de clientes:", err);
            }
          });

          // 3. Atualizar visibilidade dos links quando o checkbox mudar
          document.getElementById("toggle-clients").addEventListener("change", async (e) => {
            const updated = { clients: e.target.checked };
            try {
              const res = await fetch("/api/section-visibility", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updated),
              });
              if (!res.ok) {
                console.error("Erro ao atualizar visibilidade:", await res.text());
              }
            } catch (err) {
              console.error("Erro na requisição:", err);
            }
          });
        </script>


        <!-- Container para editar a URL do Google Maps -->
        <div class="map-config-container">
          <h2>Configurar Google Maps</h2>
          <form id="map-form" action="{{ url_for('admin_map') }}" method="post">
            <label for="map_url">URL do Iframe do Google Maps:</label>
            <input
              type="text"
              name="map_url"
              id="map_url"
              placeholder="Cole aqui a URL completa do iframe..."
              required
            />

            <!-- Nova checkbox para esconder a seção -->
            <label
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 10px;
              "
            >
              <input
                type="checkbox"
                id="hide-localizacao"
                name="hide_localizacao"
              />
              Esconder Seção
            </label>

            <button type="submit">Salvar novo mapa</button>
          </form>
        </div>

        <script>
          // Quando a página carregar
          window.addEventListener("DOMContentLoaded", async () => {
            // 1. Preencher o input map_url via JS
            try {
              const mapRes = await fetch("/api/map-url");
              const mapData = await mapRes.json();
              if (mapData?.map_url) {
                document.getElementById("map_url").value = mapData.map_url;
              }
            } catch (err) {
              console.error("Erro ao carregar URL do mapa:", err);
            }

            // 2. Marcar checkbox com base na visibilidade atual
            try {
              const visRes = await fetch("/api/section-visibility");
              const visData = await visRes.json();
              document.getElementById("hide-localizacao").checked =
                visData.localizacao === true;
            } catch (err) {
              console.error("Erro ao carregar visibilidade:", err);
            }
          });

          // 3. Atualizar visibilidade quando o checkbox mudar
          document
            .getElementById("hide-localizacao")
            .addEventListener("change", async (e) => {
              const updated = { localizacao: e.target.checked };
              try {
                const res = await fetch("/api/section-visibility", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(updated),
                });
                if (!res.ok) {
                  console.error(
                    "Erro ao atualizar visibilidade:",
                    await res.text()
                  );
                }
              } catch (err) {
                console.error("Erro na requisição:", err);
              }
            });
        </script>


        <!-- INFORMAÇÃO DE CONTATO -->
        
        <form id="contact-form">
          <h6>Editar Informações de Contato</h6>
          <label for="rua">Rua:</label>
          <input type="text" id="rua" name="rua" required>
 
          <label for="numero">Número:</label>
          <input type="text" id="numero" name="numero" required>
 
          <label for="bairro">Bairro:</label>
          <input type="text" id="bairro" name="bairro" required>
 
          <label for="cidade">Cidade:</label>
          <input type="text" id="cidade" name="cidade" required>
 
          <label for="telefone">Telefone:</label>
          <input type="text" id="telefone" name="telefone" required placeholder="(45) 3254-4200">
 
          <button type="submit">Salvar Contato</button>
        </form>

        <script>
          async function carregarContatoSalvo() {
            try {
              const res = await fetch('/get-contato');
              const data = await res.json();

              if (data && data.rua) {
                document.getElementById('rua').value = data.rua || '';
                document.getElementById('numero').value = data.numero || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.cidade || '';
                document.getElementById('telefone').value = data.telefone || '';
              }
            } catch (err) {
              console.error("Erro ao carregar contato salvo:", err);
            }
          }

          // Chama assim que a página carregar
          document.addEventListener('DOMContentLoaded', carregarContatoSalvo);

          document.getElementById('contact-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const rua = document.getElementById('rua').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            const telefone = document.getElementById('telefone').value.trim();

            const enderecoFormatado = `${rua}, N° ${numero} - ${bairro}, Cidade: ${cidade}`;

            try {
              const resposta = await fetch('/salvar-contato', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  telefone: telefone,
                  endereco: enderecoFormatado
                })
              });

              if (resposta.ok) {
                alert('Informações de contato salvas com sucesso!');
              } else {
                alert('Erro ao salvar as informações.');
              }
            } catch (err) {
              console.error('Erro:', err);
              alert('Erro ao salvar as informações.');
            }
          });
        </script>
        {% endif %}
      </div>
    </main>
  </body>
</html>
